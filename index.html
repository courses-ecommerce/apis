<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <form id="payment-form" action="/api/payment/checkout" method="post">
        <input type="radio" name="paymentMethod" value="vnPay" checked id="">
        <label for="">VnPay</label>
        <br>
        <input type="submit" name="btn_payment" value="Payment">
        <input type="button" name="btn_payment" value="Payment" onclick="postPaymentForm()">
    </form>


    <form id="login" action="" method="post">
        <input id="date" type="datetime-local"><br>
        <input id="token" name="token" type="text" placeholder="token">
        <input type="button" name="Login" value="Login" id="add" onclick="addToken()">
    </form>

    <form id="chat" action="" method="">
        <input id="text" name="text" type="text" placeholder="text">
        <input type="button" name="Send" value="Send" id="send" onclick="sendMessage()">
    </form>

    <div id="data">

    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let token = document.querySelector('#token')
        let date = document.querySelector('#date')
        let divData = document.querySelector('#data')
        let text = document.querySelector('#text')
        let send = document.querySelector('#send')

        var socket = io();

        const addToken = (e) => {
            console.log('token', token.value);
            var socket = io({
                extraHeaders: {
                    token: `Beaer ${token.value}`
                }
            });

            socket.on("send-message", (data) => {
                console.log(data);
                divData.append(`${data.text.text} ${data.text.createdAt}`)
            })

            // client-side
            socket.on("connect_error", (err) => {
                console.log(err instanceof Error); // true
                console.log(err.message); // not authorized
                console.log(err.data); // { content: "Please retry later" }
            });
        }

        const sendMessage = async (e) => {
            const res = await fetch("/api/chat/message",
                {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Beaer ${token.value}`
                    },
                    method: "POST",
                    body: JSON.stringify({
                        conversation: '62a38a5779dd87b6bed22dd8',
                        text: text.value
                    })
                })

            console.log(res);
        }


    </script>

    <!-- script for payment -->
    <script>
        let headersList = {
            "Access-Control-Allow-Origin": "*",
            "Accept": "*/*",
            'X-Remote': true,
            "Access-Control-Allow-Methods": "*",
            "Content-Type": "application/json",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJHTVMiLCJzdWIiOnsiYWNjb3VudCI6IjYyN2ZjY2FhOTM0ZGI4MjA4ZjZlZGU0OCJ9LCJpYXQiOjE2NTM5MDQ0MjUsImV4cCI6MTY1NDE2MzYyNX0.mPsg3cDqnl5_Rj6IkzTETh9tb0Lh8q9qbsgsGhD8knw",
        }
        let bodyContent = {
            paymentMethod: "vnPay"
        }

        async function postPaymentForm() {
            fetch("/api/payment/checkout", {
                method: "post",
                body: JSON.stringify(bodyContent),
                headers: headersList,
                redirect: 'follow'
            }).then(res => {
                return res.json()
            }).then(res => {
                location.href = res.url
            }).catch(e => { console.log(e); })
        }


    </script>
</body>

</html>